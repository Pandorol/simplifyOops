{"version":3,"sources":["file:///G:/sxbs2/sxbs2/assets/core/common/audio/AudioManager.ts"],"names":["AudioManager","Component","oops","AudioEffectPool","AudioMusic","LOCAL_STORE_KEY","music","effect","local_data","setMusicComplete","callback","onComplete","playMusic","url","bundleName","switch","loop","load","then","playMusicLoop","stopMusic","playing","stop","progressMusic","progress","value","volumeMusic","volume","save","switchMusic","playEffect","onPlayComplete","putEffect","aeid","put","volumeEffect","switchEffect","resumeAll","play","pauseAll","pause","stopAll","volume_music","volume_effect","switch_music","switch_effect","storage","set","getComponent","addComponent","getJson","setState","setStateDefault"],"mappings":"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","sourcesContent":["//cpall\r\nimport { AudioClip, Component } from \"cc\";\r\nimport { oops } from \"../../Oops\";\r\nimport { AudioEffectPool } from \"./AudioEffectPool\";\r\nimport { AudioMusic } from \"./AudioMusic\";\r\n\r\nconst LOCAL_STORE_KEY = \"game_audio\";\r\n\r\n/**\r\n * 音频管理\r\n * @help    https://gitee.com/dgflash/oops-framework/wikis/pages?sort_id=12037893&doc_id=2873565\r\n * @example\r\n // 模块功能通过 oops.audio 调用\r\n oops.audio.playMusic(\"audios/nocturne\");\r\n */\r\nexport class AudioManager extends Component {\r\n    /** 背景音乐管理对象 */\r\n    music: AudioMusic = null!;\r\n    /** 音效管理对象 */\r\n    effect: AudioEffectPool = new AudioEffectPool();\r\n\r\n    /** 音乐管理状态数据 */\r\n    private local_data: any = {};\r\n\r\n    /**\r\n     * 设置背景音乐播放完成回调\r\n     * @param callback 背景音乐播放完成回调\r\n     */\r\n    setMusicComplete(callback: Function | null = null) {\r\n        this.music.onComplete = callback;\r\n    }\r\n\r\n    /**\r\n     * 播放背景音乐\r\n     * @param url        资源地址\r\n     * @param callback   音乐播放完成事件\r\n     * @param bundleName 资源包名\r\n     */\r\n    playMusic(url: string, callback?: Function, bundleName?: string) {\r\n        if (this.music.switch) {\r\n            this.music.loop = false;\r\n            this.music.load(url, callback, bundleName).then();\r\n        }\r\n    }\r\n\r\n    /** 循环播放背景音乐 */\r\n    playMusicLoop(url: string, bundleName?: string) {\r\n        if (this.music.switch) {\r\n            this.music.loop = true;\r\n            this.music.load(url, null!, bundleName).then();\r\n        }\r\n    }\r\n\r\n    /** 停止背景音乐播放 */\r\n    stopMusic() {\r\n        if (this.music.switch && this.music.playing) {\r\n            this.music.stop();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 获取背景音乐播放进度\r\n     */\r\n    get progressMusic(): number {\r\n        return this.music.progress;\r\n    }\r\n\r\n    /**\r\n     * 设置背景乐播放进度\r\n     * @param value     播放进度值\r\n     */\r\n    set progressMusic(value: number) {\r\n        this.music.progress = value;\r\n    }\r\n\r\n    /**\r\n     * 获取背景音乐音量\r\n     */\r\n    get volumeMusic(): number {\r\n        return this.music.volume;\r\n    }\r\n\r\n    /**\r\n     * 设置背景音乐音量\r\n     * @param value     音乐音量值\r\n     */\r\n    set volumeMusic(value: number) {\r\n        this.music.volume = value;\r\n        this.save();\r\n    }\r\n\r\n    /**\r\n     * 获取背景音乐开关值\r\n     */\r\n    get switchMusic(): boolean {\r\n        return this.music.switch;\r\n    }\r\n\r\n    /**\r\n     * 设置背景音乐开关值\r\n     * @param value     开关值\r\n     */\r\n    set switchMusic(value: boolean) {\r\n        this.music.switch = value;\r\n        if (!value) this.music.stop();\r\n        this.save();\r\n    }\r\n\r\n    /**\r\n     * 播放音效\r\n     * @param url        资源地址\r\n     * @param callback   加载完成回调\r\n     * @param bundleName 资源包名\r\n     */\r\n    playEffect(url: string | AudioClip, bundleName?: string, onPlayComplete?: Function): Promise<number> {\r\n        return this.effect.load(url, bundleName, onPlayComplete);\r\n    }\r\n\r\n    /** 回收音效播放器 */\r\n    putEffect(aeid: number, url: string | AudioClip, bundleName?: string) {\r\n        this.effect.put(aeid, url, bundleName);\r\n    }\r\n\r\n    /** 获取音效音量 */\r\n    get volumeEffect(): number {\r\n        return this.effect.volume;\r\n    }\r\n\r\n    /**\r\n     * 设置获取音效音量\r\n     * @param value     音效音量值\r\n     */\r\n    set volumeEffect(value: number) {\r\n        this.effect.volume = value;\r\n        this.save();\r\n    }\r\n\r\n    /** 获取音效开关值 */\r\n    get switchEffect(): boolean {\r\n        return this.effect.switch;\r\n    }\r\n\r\n    /**\r\n     * 设置音效开关值\r\n     * @param value     音效开关值\r\n     */\r\n    set switchEffect(value: boolean) {\r\n        this.effect.switch = value;\r\n        if (!value) this.effect.stop();\r\n        this.save();\r\n    }\r\n\r\n    /** 恢复当前暂停的音乐与音效播放 */\r\n    resumeAll() {\r\n        if (!this.music.playing && this.music.progress > 0) this.music.play();\r\n        this.effect.play();\r\n    }\r\n\r\n    /** 暂停当前音乐与音效的播放 */\r\n    pauseAll() {\r\n        if (this.music.playing) this.music.pause();\r\n        this.effect.pause();\r\n    }\r\n\r\n    /** 停止当前音乐与音效的播放 */\r\n    stopAll() {\r\n        this.music.stop();\r\n        this.effect.stop();\r\n    }\r\n\r\n    /** 保存音乐音效的音量、开关配置数据到本地 */\r\n    save() {\r\n        this.local_data.volume_music = this.music.volume;\r\n        this.local_data.volume_effect = this.effect.volume;\r\n        this.local_data.switch_music = this.music.switch;\r\n        this.local_data.switch_effect = this.effect.switch;\r\n\r\n        oops.storage.set(LOCAL_STORE_KEY, this.local_data);\r\n    }\r\n\r\n    /** 本地加载音乐音效的音量、开关配置数据并设置到游戏中 */\r\n    load() {\r\n        this.music = this.getComponent(AudioMusic) || this.addComponent(AudioMusic)!;\r\n\r\n        this.local_data = oops.storage.getJson(LOCAL_STORE_KEY);\r\n        if (this.local_data) {\r\n            try {\r\n                this.setState();\r\n            }\r\n            catch {\r\n                this.setStateDefault();\r\n            }\r\n        }\r\n        else {\r\n            this.setStateDefault();\r\n        }\r\n    }\r\n\r\n    private setState() {\r\n        this.music.volume = this.local_data.volume_music;\r\n        this.effect.volume = this.local_data.volume_effect;\r\n        this.music.switch = this.local_data.switch_music;\r\n        this.effect.switch = this.local_data.switch_effect;\r\n    }\r\n\r\n    private setStateDefault() {\r\n        this.local_data = {};\r\n        this.music.volume = 1;\r\n        this.effect.volume = 1;\r\n        this.music.switch = true;\r\n        this.effect.switch = true;\r\n    }\r\n}"]}