{"version":3,"sources":["file:///G:/sxbs2/sxbs2/assets/libs/gui/language/LanguagePack.ts"],"names":["LanguagePack","director","error","JsonAsset","TTFFont","resLoader","Logger","JsonUtil","LanguageData","LanguageType","updateLanguage","lang","rootNodes","getScene","children","i","length","forEach","type","comps","getComponentsInChildren","j","language","loadLanguageAssets","callback","loadTexture","loadSpine","loadJson","loadTable","Promise","resolve","reject","excel","loadAsync","logConfig","path","path_texture","loadDir","err","assets","path_json","jsonAsset","json","load","font","path_spine","releaseLanguageAssets","langTexture","releaseDir","langJson","get","decRef","langSpine","release"],"mappings":"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","sourcesContent":["//cpall\r\nimport { director, error, JsonAsset, TTFFont } from \"cc\";\r\nimport { resLoader } from \"../../../core/common/loader/ResLoader\";\r\nimport { Logger } from \"../../../core/common/log/Logger\";\r\nimport { JsonUtil } from \"../../../core/utils/JsonUtil\";\r\nimport { LanguageData, LanguageType } from \"./LanguageData\";\r\n\r\nexport class LanguagePack {\r\n    /**\r\n     * 刷新语言文字\r\n     * @param lang \r\n     */\r\n    updateLanguage(lang: string) {\r\n        let rootNodes = director.getScene()!.children;\r\n        for (let i = 0; i < rootNodes.length; ++i) {\r\n            LanguageType.forEach(type => {\r\n                let comps: any[] = rootNodes[i].getComponentsInChildren(type);\r\n                for (let j = 0; j < comps.length; j++) {\r\n                    comps[j].language();\r\n                }\r\n            })\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 下载对应语言包资源\r\n     * @param lang 语言标识\r\n     * @param callback 下载完成回调\r\n     */\r\n    async loadLanguageAssets(lang: string, callback: Function) {\r\n        await this.loadTexture(lang);\r\n        await this.loadSpine(lang);\r\n        await this.loadJson(lang);\r\n        await this.loadTable(lang);\r\n\r\n        callback(lang);\r\n    }\r\n\r\n    /** 多语言Excel配置表数据 */\r\n    private loadTable(lang: string) {\r\n        return new Promise(async (resolve, reject) => {\r\n            LanguageData.excel = await JsonUtil.loadAsync(\"Language\");\r\n            if (LanguageData.excel) {\r\n                Logger.logConfig(\"config/game/Language\", \"下载语言包 table 资源\");\r\n            }\r\n            resolve(null);\r\n        });\r\n    }\r\n\r\n    /** 纹理多语言资源 */\r\n    private loadTexture(lang: string) {\r\n        return new Promise((resolve, reject) => {\r\n            const path = `${LanguageData.path_texture}/${lang}`;\r\n            resLoader.loadDir(path, (err: any, assets: any) => {\r\n                if (err) {\r\n                    error(err);\r\n                    resolve(null);\r\n                    return;\r\n                }\r\n                Logger.logConfig(path, \"下载语言包 textures 资源\");\r\n                resolve(null);\r\n            });\r\n        });\r\n    }\r\n\r\n    /** Json格式多语言资源 */\r\n    private loadJson(lang: string) {\r\n        return new Promise(async (resolve, reject) => {\r\n            const path = `${LanguageData.path_json}/${lang}`;\r\n            const jsonAsset = await resLoader.loadAsync(path, JsonAsset);\r\n            if (jsonAsset) {\r\n                LanguageData.json = jsonAsset.json;\r\n                Logger.logConfig(path, \"下载语言包 json 资源\");\r\n            }\r\n            else {\r\n                resolve(null);\r\n                return;\r\n            }\r\n\r\n            resLoader.load(path, TTFFont, (err: Error | null, font: TTFFont) => {\r\n                if (err == null) Logger.logConfig(path, \"下载语言包 ttf 资源\");\r\n                LanguageData.font = font;\r\n                resolve(null);\r\n            });\r\n        });\r\n    }\r\n\r\n    /** SPINE动画多语言资源 */\r\n    private loadSpine(lang: string) {\r\n        return new Promise(async (resolve, reject) => {\r\n            const path = `${LanguageData.path_spine}/${lang}`;\r\n            resLoader.loadDir(path, (err: any, assets: any) => {\r\n                if (err) {\r\n                    error(err);\r\n                    resolve(null);\r\n                    return;\r\n                }\r\n                Logger.logConfig(path, \"下载语言包 spine 资源\");\r\n                resolve(null);\r\n            })\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 释放某个语言的语言包资源包括json\r\n     * @param lang \r\n     */\r\n    releaseLanguageAssets(lang: string) {\r\n        let langTexture = `${LanguageData.path_texture}/${lang}`;\r\n        resLoader.releaseDir(langTexture);\r\n\r\n        let langJson = `${LanguageData.path_json}/${lang}`;\r\n        let json = resLoader.get(langJson, JsonAsset);\r\n        if (json) {\r\n            json.decRef();\r\n        }\r\n\r\n        let font = resLoader.get(langJson, TTFFont);\r\n        if (font) {\r\n            font.decRef();\r\n        }\r\n\r\n        let langSpine = `${LanguageData.path_spine}/${lang}`;\r\n        resLoader.release(langSpine);\r\n    }\r\n}"]}