{"version":3,"sources":["file:///G:/sxbs2/sxbs2/assets/core/Root.ts"],"names":["_decorator","Component","director","Game","game","JsonAsset","Node","screen","sys","GameConfig","GameQueryConfig","oops","version","AudioManager","EventMessage","message","resLoader","StorageManager","StorageSecuritySimple","TimerManager","GameManager","LayerManager","property","isInited","Root","type","tooltip","persist","onLoad","console","log","enabled","iniStart","loadConfig","then","addPersistRootNode","res","config_name","config","loadAsync","query","defaultBundleName","bundleDefault","init","data","bundle","storage","audio","addComponent","load","timer","gui","http","server","httpServer","timeout","httpTimeout","frameRate","run","release","update","dt","ecs","execute","initGui","initEcsSystem","on","EVENT_SHOW","onShow","EVENT_HIDE","onHide","isMobile","dispatchEvent","GAME_RESIZE","GAME_FULL_SCREEN","GAME_ORIENTATION","resume","pause"],"mappings":"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","sourcesContent":["//cpall\r\nimport { _decorator, Component, director, Game, game, JsonAsset, Node, screen, sys } from \"cc\";\r\nimport { GameConfig } from \"../module/config/GameConfig\";\r\nimport { GameQueryConfig } from \"../module/config/GameQueryConfig\";\r\nimport { oops, version } from \"./Oops\";\r\nimport { AudioManager } from \"./common/audio/AudioManager\";\r\nimport { EventMessage } from \"./common/event/EventMessage\";\r\nimport { message } from \"./common/event/MessageManager\";\r\nimport { resLoader } from \"./common/loader/ResLoader\";\r\nimport { StorageManager } from \"./common/storage/StorageManager\";\r\nimport { StorageSecuritySimple } from \"./common/storage/StorageSecuritySimple\";\r\nimport { TimerManager } from \"./common/timer/TimerManager\";\r\nimport { GameManager } from \"./game/GameManager\";\r\nimport { LayerManager } from \"./gui/layer/LayerManager\";\r\n\r\nconst { property } = _decorator;\r\n\r\nlet isInited = false;\r\n\r\n/** 框架显示层根节点 */\r\nexport class Root extends Component {\r\n    /** 游戏层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"游戏层\"\r\n    })\r\n    game: Node = null!;            // 可使用多摄像机自定义二维或三维游戏场景\r\n\r\n    /** 界面层节点 */\r\n    @property({\r\n        type: Node,\r\n        tooltip: \"界面层\"\r\n    })\r\n    gui: Node = null!;\r\n\r\n    /** 框架常驻节点 */\r\n    private persist: Node = null!\r\n\r\n    onLoad() {\r\n        if (!isInited) {\r\n            isInited = true;      // 注：这里是规避cc3.8在编辑器模式下运行时，关闭游戏会两次初始化报错\r\n\r\n            console.log(`Oops Framework v${version}`);\r\n            this.enabled = false;\r\n            this.iniStart();\r\n            this.loadConfig().then();\r\n        }\r\n    }\r\n\r\n    private async loadConfig() {\r\n        // 创建持久根节点\r\n        this.persist = new Node(\"OopsFrameworkPersistNode\");\r\n        director.addPersistRootNode(this.persist);\r\n\r\n        // 资源管理模块\r\n        oops.res = resLoader;\r\n\r\n        const config_name = \"config\";\r\n        const config = await oops.res.loadAsync(config_name, JsonAsset);\r\n        if (config) {\r\n            // oops.config.btc = new BuildTimeConstants();\r\n            oops.config.query = new GameQueryConfig();\r\n            oops.config.game = new GameConfig(config);\r\n\r\n            // 设置默认资源包\r\n            oops.res.defaultBundleName = oops.config.game.bundleDefault;\r\n            oops.res.init(oops.config.game.data.bundle);\r\n\r\n            // 本地存储模块\r\n            oops.storage = new StorageManager();\r\n            oops.storage.init(new StorageSecuritySimple);\r\n\r\n\r\n            // 全局消息\r\n            oops.message = message;\r\n\r\n            // 创建音频模块\r\n            oops.audio = this.persist.addComponent(AudioManager);\r\n            oops.audio.load();\r\n\r\n            // 创建时间模块\r\n            oops.timer = this.persist.addComponent(TimerManager)!;\r\n\r\n            // 游戏场景管理\r\n            oops.game = new GameManager(this.game);\r\n\r\n            // 游戏界面管理\r\n            oops.gui = new LayerManager(this.gui);\r\n\r\n            // 网络模块\r\n            oops.http.server = oops.config.game.httpServer;                                      // Http 服务器地址\r\n            oops.http.timeout = oops.config.game.httpTimeout;                                    // Http 请求超时时间\r\n\r\n            game.frameRate = oops.config.game.frameRate;                                         // 初始化每秒传输帧数\r\n\r\n            this.enabled = true;\r\n            this.init();\r\n            this.run();\r\n\r\n            oops.res.release(config_name);\r\n        }\r\n        else {\r\n            this.loadConfig().then();\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        oops.ecs.execute(dt);\r\n    }\r\n\r\n    /** 初始化开始 */\r\n    protected iniStart() {\r\n\r\n    }\r\n\r\n    /** 初始化游戏界面 */\r\n    protected initGui() {\r\n\r\n    }\r\n\r\n    /** 初始化游戏业务模块 */\r\n    protected initEcsSystem() {\r\n\r\n    }\r\n\r\n    /** 加载完引擎配置文件后执行 */\r\n    protected run() {\r\n\r\n    }\r\n\r\n    private init() {\r\n        this.initGui();\r\n        this.initEcsSystem();\r\n        oops.ecs.init();\r\n\r\n        // 游戏显示事件\r\n        game.on(Game.EVENT_SHOW, this.onShow, this);\r\n        // 游戏隐藏事件\r\n        game.on(Game.EVENT_HIDE, this.onHide, this);\r\n\r\n        // 游戏尺寸修改事件\r\n        if (!sys.isMobile) {\r\n            screen.on(\"window-resize\", () => {\r\n                oops.message.dispatchEvent(EventMessage.GAME_RESIZE);\r\n            }, this);\r\n\r\n            screen.on(\"fullscreen-change\", () => {\r\n                oops.message.dispatchEvent(EventMessage.GAME_FULL_SCREEN);\r\n            }, this);\r\n        }\r\n\r\n        screen.on(\"orientation-change\", () => {\r\n            oops.message.dispatchEvent(EventMessage.GAME_ORIENTATION);\r\n        }, this);\r\n    }\r\n\r\n    private onShow() {\r\n        // oops.timer.load();              // 处理回到游戏时减去逝去时间\r\n        // oops.audio.resumeAll();         // 恢复所有暂停的音乐播放\r\n        director.resume();              // 恢复暂停场景的游戏逻辑，如果当前场景没有暂停将没任何事情发生\r\n        game.resume();                  // 恢复游戏主循环。包含：游戏逻辑，渲染，事件处理，背景音乐和所有音效\r\n        // oops.message.dispatchEvent(EventMessage.GAME_SHOW);\r\n    }\r\n\r\n    private onHide() {\r\n        // oops.timer.save();             // 处理切到后台后记录切出时间\r\n        // oops.audio.pauseAll();         // 暂停所有音乐播放\r\n        director.pause();              // 暂停正在运行的场景，该暂停只会停止游戏逻辑执行，但是不会停止渲染和 UI 响应。 如果想要更彻底得暂停游戏，包含渲染，音频和事件\r\n        game.pause();                  // 暂停游戏主循环。包含：游戏逻辑、渲染、输入事件派发（Web 和小游戏平台除外）\r\n        // oops.message.dispatchEvent(EventMessage.GAME_HIDE);\r\n    }\r\n}"]}